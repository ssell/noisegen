function rgbToHsv(b,a,d){var c={h:0,s:0,v:0},f=Math.max(b,Math.max(a,d)),g=f-Math.min(b,Math.min(a,d));c.v=f;1E-5>g?(c.s=0,c.h=0):0<f&&(c.s=g/f,c.h=b>=f?(a-d)/g:a>=f?2+(d-b)/g:4+(b-a)/g,c.h*=60,0>c.h&&(c.h+=360));return c}
function hsvToRgb(b,a,d){var c={r:d,g:d,b:d};if(0<a){var f=.01666666666*(360<=b?0:b);b=Math.trunc(f);var g=f-b,f=d*(1-a),e=d*(1-a*g);a=d*(1-a*(1-g));switch(b){case 0:c.r=d;c.g=a;c.b=f;break;case 1:c.r=e;c.g=d;c.b=f;break;case 2:c.r=f;c.g=d;c.b=a;break;case 3:c.r=f;c.g=e;c.b=d;break;case 4:c.r=a;c.g=f;c.b=d;break;default:c.r=d,c.g=f,c.b=e}}return c}function lerp(b,a,d){return b*(1-d)+a*d}
function lerpColorRGB(b,a,d,c,f,g,e){return{r:Math.trunc(lerp(b,c,e)),g:Math.trunc(lerp(a,f,e)),b:Math.trunc(lerp(d,g,e))}}function lerpColorHSV(b,a,d,c,f,g,e){b=rgbToHsv(b,a,d);g=rgbToHsv(c,f,g);c=lerp(b.h,g.h,e);f=lerp(b.s,g.s,e);e=lerp(b.v,g.v,e);e=hsvToRgb(c,f,e);return{r:e.r,g:e.g,b:e.b}}var PaletteSegment=function(b){b=b.split(",");this.start=parseInt(b[0]);this.r=parseInt(b[1]);this.g=parseInt(b[2]);this.b=parseInt(b[3]);this.mode=b[4]};
PaletteSegment.prototype.toStr=function(){return"mode = "+this.mode+" | start = "+this.start+" | ("+this.r+","+this.g+", "+this.b+")"};var Palette=function(){this.descriptor=null;this.segments=[]};Palette.prototype.build=function(b){this.descriptor=b;this.segments=[];for(var a=0;a<b.length;++a)this.segments.push(new PaletteSegment(b[a]));this.segments.sort(function(a,b){return a.start-b.start})};
Palette.prototype.findSegment=function(b){for(var a=0,d=0;d<this.segments.length;++d)if(this.segments[d].start<b)a=d;else break;return a};
Palette.prototype.transform=function(b){var a=this.findSegment(b),d=b,c=b,f=b;if(a<this.segments.length){var g=String(this.segments[a].mode).toLocaleLowerCase();if(0==g.localeCompare("solid"))d=this.segments[a].r,c=this.segments[a].g,f=this.segments[a].b;else if(g.includes("smooth"))if(a<this.segments.length-1){var e=this.segments[a],a=this.segments[a+1];b=(b-e.start)/(a.start-e.start);var h=null;g.includes("rgb")?h=lerpColorRGB(e.r,e.g,e.b,a.r,a.g,a.b,b):g.includes("hsv")&&(h=lerpColorHSV(e.r,e.g,
e.b,a.r,a.g,a.b,b));h&&(d=h.r,c=h.g,f=h.b)}else e=this.segments[a],d=e.r,c=e.g,f=e.b}return{r:d,g:c,b:f}};var Surface=function(){this.height=this.width=1;this.canvas=document.getElementById("surface");this.context=this.canvas.getContext("2d");this.rawImageData=this.context.createImageData(this.width,this.height);this.rawMaxValue=0;this.rawMinValue=1;this.gray=!1;this.grayPalette=new Palette;this.colorPalette=new Palette;this.activePalette=this.gray?this.grayPalette:this.colorPalette};
Surface.prototype.clear=function(b,a,d){this.context.fillStyle="rgb("+b+","+a+","+d+")";this.context.fillRect(0,0,this.width,this.height)};Surface.prototype.resize=function(b,a){if(this.width!=b||this.height!=a)this.width=b,this.height=a,this.canvas.width=b,this.canvas.height=a,this.rawImageData=this.context.createImageData(b,a),$("#surface").attr("width",b),$("#surface").attr("height",a)};Surface.prototype.updateRawImageData=function(){this.rawImageData=this.context.getImageData(0,0,this.width,this.height)};
Surface.prototype.getRawImageData=function(){return this.rawImageData};Surface.prototype.normalizeRawImage=function(){this.rawMaxValue=0;this.rawMinValue=1;for(var b=this.rawImageData.length;b--;)this.rawImageData[b]<this.rawMinValue&&(this.rawMinValue=this.rawImageData[b]),this.rawImageData[b]>this.rawMaxValue&&(this.rawMaxValue=this.rawImageData[b]);for(var a=1/(this.rawMaxValue-this.rawMinValue),b=this.rawImageData.length;b--;)this.rawImageData[b]=(this.rawImageData[b]-this.rawMinValue)*a};
Surface.prototype.drawImage=function(b){this.context.putImageData(b,0,0)};Surface.prototype.drawImageRect=function(b,a,d,c,f){this.context.putImageData(b,0,0,a,c,d-a,f-c)};Surface.prototype.size=function(){return this.width*this.height};Surface.prototype.getURL=function(){return this.canvas.toDataURL().replace(/^data:image\/[^;]/,"data:application/octet-stream")};Surface.prototype.setPalette=function(b,a){a?this.grayPalette.build(b):this.colorPalette.build(b)};
Surface.prototype.getPalette=function(){return this.activePalette=this.gray?this.grayPalette:this.colorPalette};
self.onmessage=function(b){var a=b.data;if(a){var d=a.paletteDescr;b=a.startX;var c=a.startY,f=a.endX,g=a.endY,e=a.srcImage,a=a.destImage,h=new Palette;h.build(d);for(var d=g-c,p=e.width,k,l,m=b;m<f;++m){for(var n=c;n<g;++n)l=4*(n*p+m),k=e.data[l],k=h.transform(k),a.data[l+0]=k.r,a.data[l+1]=k.g,a.data[l+2]=k.b,a.data[l+3]=255;postMessage({progress:d})}postMessage({image:a,startX:b,endX:f,startY:c,endY:g})}};