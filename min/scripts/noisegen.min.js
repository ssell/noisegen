function destroyWorkers(b){for(var a=0;a<b.length;++a)b[a].terminate(),b[a]=null}
function triggerNoiseWorkers(b,a,e,f,d,h,c,g){for(var k=0,q=Array(d*d),l=0;l<d;++l)for(var m=0;m<d;++m){var n=l*d+m,p=l*h,r=(l+1)*h,t=m*c,u=(m+1)*c;q[n]=new Worker("min/scripts/noise.min.js");q[n].postMessage({isRaw:!1,image:a,noise:e,noiseParams:f,width:a.width,height:a.height,startX:p,endX:r,startY:t,endY:u});q[n].onmessage=function(a){a.data.progress?NoiseProgressBar.update(a.data.progress):(b.drawImageRect(a.data.image,a.data.startX,a.data.endX,a.data.startY,a.data.endY),k++,k==d*d&&(destroyWorkers(q),
b.updateRawImageData(),g()))}}}function putRawData(b,a,e,f,d,h,c){for(var g=f;g<d;++g)for(var k=h;k<c;++k)f=k*e+g,a[f]=b[f]}
function triggerNormalizedWorkers(b,a,e,f,d,h,c,g,k,q){for(var l=Array(h*c),m=0,n=d*d,p=Array(n),r=0;r<d;++r)for(var t=0;t<d;++t){var u=r*d+t,v=r*g,w=(r+1)*g,x=t*k,y=(t+1)*k;p[u]=new Worker("min/scripts/noise.min.js");p[u].postMessage({isRaw:!0,rawData:l,noise:e,noiseParams:f,width:h,height:c,startX:v,endX:w,startY:x,endY:y});p[u].onmessage=function(c){if(c.data.progress)NoiseProgressBar.update(c.data.progress);else if(putRawData(c.data.rawData,l,h,c.data.startX,c.data.endX,c.data.startY,c.data.endY),
m++,m==n){NoiseProgressBar.setTitle("Normalizing Data ...");var d=new Worker("min/scripts/noise_normalization.min.js");d.postMessage({raw:l,image:a});d.onmessage=function(a){b.drawImage(a.data.image);b.updateRawImageData();destroyWorkers(p);destroyWorkers([d]);q()}}}}}function generateNoiseMultithreaded(b,a,e,f,d,h){var c=b.getRawImageData(),g=c.width/d,k=c.height/d;e?triggerNormalizedWorkers(b,c,a,f,d,c.width,c.height,g,k,h):triggerNoiseWorkers(b,c,a,f,d,g,k,h)}
function applyPaletteMultithreaded(b,a,e){for(var f=0,d=b.getRawImageData(),h=b.context.createImageData(d),c=b.getPalette().descriptor,g=d.width/a,k=d.height/a,q=a*a,l=Array(q),m=0;m<a;++m)for(var n=0;n<a;++n){var p=m*a+n,r=m*g,t=(m+1)*g,u=n*k,v=(n+1)*k;l[p]=new Worker("min/scripts/surface.min.js");l[p].postMessage({srcImage:d,destImage:h,paletteDescr:c,startX:r,endX:t,startY:u,endY:v});l[p].onmessage=function(a){a.data.progress?NoiseProgressBar.update(a.data.progress):(b.drawImageRect(a.data.image,
a.data.startX,a.data.endX,a.data.startY,a.data.endY),f++,f==q&&(destroyWorkers(l),e()))}}}var gSurface=null,gGrayMultiRange=null,gColorMultiRange=null;function populateAlgorithmList(){$("#noise_algorithms").append("<option value='"+NoisePerlin.type+"'>"+NoisePerlin.type+"</option><option value='"+NoiseSimplex.type+"' selected>"+NoiseSimplex.type+"</option><option value='"+NoiseWorley.type+"'>"+NoiseWorley.type+"</option><option value='"+NoiseRandom.type+"'>"+NoiseRandom.type+"</option>")}
function getSelectedAlgorithm(){return $("#noise_algorithms").val()}function getNormalized(){return $("#noise_normalized").is(":checked")}function buildNoiseParamsList(){var b="";$("#noise_content .noise_property_value").each(function(){var a=$(this).attr("id"),a=a.substr(0,a.length-6),e;e=$(this).is("input")?$(this).val():$(this).text();b+=a+":"+e+";"});return b+="seed:"+uint32(Number($("#noise_seed").val()))+";"}function roundDownToEven(b){return 2*Math.floor(.5*b)}
function updateDimensions(){var b=$("#surface_width"),a=$("#surface_height"),e=Number(b.val()),f=Number(a.val());0==e&&(e=$(document).width());0==f&&(f=$(document).height());e=roundDownToEven(e);f=roundDownToEven(f);b.val(e);a.val(f);gSurface.resize(e,f);gSurface.clear(51,51,51)}function updateInput(b){var a=$("#"+b);b=$("#"+b+"_value");a&&b&&(b.is("input")?b.val(a.val()):b.html(a.val()))}function toggleGenerateButton(){$("#generate_button").prop("disabled",function(b,a){return!a})}
function toggleApplyButton(){$("#color_apply_button").prop("disabled",function(b,a){return!a})}function enableExportButton(){$("#export_button").prop("disabled","")}function triggerExport(){var b=$("<a>").attr("href",gSurface.getURL()).attr("download","noise.png").appendTo("body");b[0].click();b.remove()}
function triggerUIRebuild(){buildUI(getUIParams(getSelectedAlgorithm()));$("#noise_content .ui_element").change(function(){updateInput($(this).attr("id"))});$("#noise_content .noise_property_value").change(function(){$(this).parent().parent().find(".ui_element").val($(this).val())})}
function enableColorModeGray(){gSurface.gray=!0;$("#grayscale_button").addClass("color_button_selected");$("#color_button").removeClass("color_button_selected");$("#ui_color_grayscale").removeClass("hidden");$("#ui_color_color").addClass("hidden");gGrayMultiRange.update()}
function enableColorModeColor(){gSurface.gray=!1;$("#color_button").addClass("color_button_selected");$("#grayscale_button").removeClass("color_button_selected");$("#ui_color_color").removeClass("hidden");$("#ui_color_grayscale").addClass("hidden");gColorMultiRange.update()}function toggleColorMode(){gSurface.gray?enableColorModeColor():enableColorModeGray()}function generateStop(){NoiseProgressBar.stop();toggleGenerateButton();toggleApplyButton();enableExportButton()}
function generateStart(){toggleGenerateButton();toggleApplyButton();updateDimensions();NoiseProgressBar.start(gSurface.size(),"Generating ...");generateNoiseMultithreaded(gSurface,getSelectedAlgorithm(),getNormalized(),buildNoiseParamsList(),2,generateStop)}function applyColorPropertiesStop(){NoiseProgressBar.stop();toggleApplyButton();toggleGenerateButton()}
function applyColorPropertiesStart(){var b;b=gSurface.gray?toPaletteDescriptor(gGrayMultiRange):toPaletteDescriptor(gColorMultiRange);gSurface.setPalette(b,gSurface.gray);NoiseProgressBar.start(gSurface.size(),"Applying Palette ...");toggleApplyButton();toggleGenerateButton();applyPaletteMultithreaded(gSurface,2,applyColorPropertiesStop)}function isValidHexChar(b){return"0"<=b&&"9">=b||"a"<=b&&"f">=b||"A"<=b&&"F">=b}
function isValidHexString(b){if(7!=b.length)return!1;for(var a=1;a<b.length;++a)if(!isValidHexChar(b[a]))return!1;return!0}
function applyPaletteString(){var b=!0,a=$("#color_templates").val().split(";"),e=a.length-1;if(0<e){for(var f=Array(e-1),d=Array(e),h=Array(e),c=0;c<e;++c){var g=a[c].split(",");if(5!=g.length){b=!1;break}0!=c&&(f[c-1]=Number(g[0]));d[c]=rgbToHex(Number(g[1]),Number(g[2]),Number(g[3]));h[c]=g[4]}if(b){for(c=0;c<f.length;++c)if(0>f[c]||255<f[c]){console.log("thumbValues["+c+"] invalid ("+f[c]+")");b=!1;break}for(c=0;c<d.length;++c)if(!isValidHexString(d[c])){console.log("segmentColors["+c+"] invalid ("+
d[c]+")");b=!1;break}for(c=0;c<h.length;++c)if(a=h[c].toUpperCase(),"SOLID"!==a&&"SMOOTH RGB"!==a&&"SMOOTH HSV"!==a&&"NONE"!==a){console.log("segmentModes["+c+"] invalid ("+h[c]+")");b=!1;break}}}else b=!1;b?(gColorMultiRange.load(f,d,h),$("#color_templates").css("border-bottom","1px solid transparent")):$("#color_templates").css("border-bottom","1px solid #AA3333")}
function updatePaletteString(){var b="",a;a=gSurface.gray?toPaletteDescriptor(gGrayMultiRange):toPaletteDescriptor(gColorMultiRange);for(var e=0;e<a.length;++e)b+=a[e]+";";$("#color_templates").val(b);$("#color_templates").css("border-bottom","1px solid transparent")}function multirangeUpdateCallback(){updatePaletteString()}function buildColorPropertiesGray(){var b=buildMultiRanges($("#ui_color_grayscale"),multirangeUpdateCallback);b.length&&(gGrayMultiRange=b[0])}
function buildColorPropertiesColor(){var b=buildMultiRanges($("#ui_color_color"),multirangeUpdateCallback);b.length&&(gColorMultiRange=b[0])}function buildColorProperties(){buildColorPropertiesGray();buildColorPropertiesColor()}function handleMinimize(b){var a=b.split("_")[1]+"_content";if(a=$("#"+a))a.hasClass("hidden")?(a.removeClass("hidden"),$("#"+b).html("<a>&#x25BE;</a>")):(a.addClass("hidden"),$("#"+b).html("<a>&#x25C2;</a>"))}
$(document).ready(function(){gSurface=new Surface;buildColorProperties();populateAlgorithmList();updateDimensions();triggerUIRebuild();updatePaletteString();$("#set_palette").click(function(){applyPaletteString()});$("#generate_button").click(function(){generateStart()});$("#export_button").click(function(){triggerExport()});$("#noise_algorithms").change(function(){triggerUIRebuild()});$(".color_button").click(function(){toggleColorMode()});$("#color_apply_button").click(function(){applyColorPropertiesStart()});
$(".minimize").click(function(){handleMinimize($(this).attr("id"))})});